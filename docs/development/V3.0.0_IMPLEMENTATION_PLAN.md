# v3.0.0 Implementation Plan

**Date:** 2025-10-02
**Branch:** `feature/v3.0.0-notion-api-2025-09-03`
**Type:** BREAKING CHANGES
**Base:** main (v2.0.0)

---

## Overview

v3.0.0 implements the **Notion API 2025-09-03** with breaking changes that require `data_source_id` instead of `database_id`.

**Key Change:** Operations shift from database-centric to data-source-centric.

---

## Changes Required

### 1. notion-client.js - Core API Changes

#### A. Constructor (lines 1-18)
**Before:**
```javascript
this.dataSourceId = config.notion.dataSourceId || null; // v2.0.0: Optional
```

**After:**
```javascript
this.dataSourceId = config.notion.dataSourceId; // v3.0.0: Required
if (!this.dataSourceId) {
    throw new Error('dataSourceId is required in v3.0.0. Run: npm run fetch-data-source-id');
}
```

#### B. createPage() - Line 86-89
**Before:**
```javascript
parent: {
    database_id: this.databaseId,
}
```

**After:**
```javascript
parent: {
    data_source_id: this.dataSourceId,
}
```

#### C. findPageByUrl() - Lines 1113-1121
**Before:**
```javascript
const response = await this.notion.databases.query({
    database_id: this.databaseId,
    filter: {
        property: 'URL',
        url: { equals: url }
    }
});
```

**After:**
```javascript
const response = await this.notion.dataSources.query({
    data_source_id: this.dataSourceId,
    filter: {
        property: 'URL',
        url: { equals: url }
    }
});
```

#### D. findExistingPage() - Lines 1431-1438
**Before:**
```javascript
const response = await this.notion.databases.query({
    database_id: this.databaseId,
    filter: {
        property: 'URL',
        url: { equals: sourceUrl }
    }
});
```

**After:**
```javascript
const response = await this.notion.dataSources.query({
    data_source_id: this.dataSourceId,
    filter: {
        property: 'URL',
        url: { equals: sourceUrl }
    }
});
```

#### E. Set Default API Version - Line 8
**Before:**
```javascript
notionVersion: config.notion.apiVersion || undefined,
```

**After:**
```javascript
notionVersion: config.notion.apiVersion || '2025-09-03',
```

#### F. Remove Backward Compatibility Warning - Lines 14-17
**Remove:**
```javascript
// v2.0.0: Warn about future requirement
if (!this.dataSourceId && this.apiVersion === 'default') {
    console.warn('‚ö†Ô∏è  Future versions may require a data source ID...');
}
```

---

### 2. ConfigManager.js - Validation

**File:** `/local-app/src/config/ConfigManager.js`

**Add validation:**
```javascript
validateNotionConfig() {
    const required = ['apiKey', 'databaseId', 'dataSourceId'];
    const missing = required.filter(key => !this.config.notion?.[key]);

    if (missing.length > 0) {
        throw new Error(
            `Missing required Notion config: ${missing.join(', ')}\n` +
            `Run: npm run fetch-data-source-id`
        );
    }
}
```

---

### 3. interactive-setup.js - Setup Flow

**File:** `/local-app/src/setup/interactive-setup.js`

**Add data source ID fetching to setup:**
```javascript
// After database ID is entered
console.log('Fetching data source ID...');
const dataSourceId = await fetchDataSourceIdForDatabase(apiKey, databaseId);
config.notion.dataSourceId = dataSourceId;
```

---

### 4. config.example.json - Example Config

**Update example:**
```json
{
  "notion": {
    "apiKey": "${NOTION_API_KEY}",
    "databaseId": "${NOTION_DATABASE_ID}",
    "dataSourceId": "${NOTION_DATA_SOURCE_ID}",
    "apiVersion": "2025-09-03"
  }
}
```

---

### 5. Version Numbers

**Update in:**
1. `/local-app/package.json` - version: "3.0.0"
2. `/greasemonkey-script/linkedin-notion-saver-v3.0.0.user.js` - @version 3.0.0 (if needed)
3. `/CHANGELOG.md` - Add v3.0.0 section

---

### 6. Documentation

**Create:**
1. `/docs/development/MIGRATION_v3.md` - User migration guide
2. `/docs/releases/v3.0.0.md` - Release notes

**Update:**
1. `/README.md` - Note about v3.0.0 breaking changes
2. `/MIGRATION.md` - Add v2‚Üív3 section
3. `/docs/development/NOTION_API_MIGRATION_PLAN.md` - Mark Phase 2 complete

---

## Testing Strategy

### 1. Unit Tests
- [ ] Test NotionClient requires dataSourceId
- [ ] Test error message when dataSourceId missing
- [ ] Test data_source_id used in createPage()
- [ ] Test dataSources.query() used in findPageByUrl()
- [ ] Test dataSources.query() used in findExistingPage()

### 2. Integration Tests
- [ ] Create real Notion page with data_source_id
- [ ] Query existing pages with dataSources.query()
- [ ] Test migration from v2.0.0 config
- [ ] Test interactive setup fetches dataSourceId

### 3. Real-World Tests
- [ ] Save LinkedIn post to Notion
- [ ] Verify duplicate detection works
- [ ] Test with video (if possible)
- [ ] Test with images (if possible)

---

## Migration Path for Users

### v2.0.0 ‚Üí v3.0.0

**Difficulty:** ‚≠ê‚≠ê Medium (config change required)
**Time:** 10 minutes
**Rollback:** Easy (revert to v2.0.0)

**Steps:**
```bash
# 1. Fetch data source ID
npm run fetch-data-source-id

# 2. Add to config.json
{
  "notion": {
    "dataSourceId": "abc123..."  # Add this line
  }
}

# 3. Upgrade
git pull origin main
cd local-app && npm install
npm start
```

---

## Breaking Changes

### What Breaks

1. ‚ùå **Config without dataSourceId** - App will not start
2. ‚ùå **Old API patterns** - No longer supported
3. ‚ùå **databases.query()** - Replaced with dataSources.query()

### What Doesn't Break

1. ‚úÖ **Database ID still used** - For backwards compatibility
2. ‚úÖ **Existing Notion pages** - No changes needed
3. ‚úÖ **Greasemonkey script** - No changes needed

---

## Risk Assessment

### High Risk ‚ö†Ô∏è
- **Breaking changes** - Users must update config
- **API pattern change** - New Notion SDK methods used
- **Untested in production** - New API patterns not validated

### Medium Risk üü°
- **Migration complexity** - Users need to fetch dataSourceId
- **Error handling** - Need good error messages

### Low Risk üü¢
- **SDK already upgraded** - v5.1.0 in v2.0.0
- **Helper script exists** - fetch-data-source-id.js ready
- **Clear documentation** - Migration guide planned

---

## Rollback Plan

### If v3.0.0 Fails

**Option 1: Revert to v2.0.0**
```bash
git checkout v2.0.0
cd local-app && npm install
npm start
```

**Option 2: Fix Forward**
- Keep old config backup
- Test each change individually
- Fix issues incrementally

---

## Success Criteria

### Code
- [ ] All 4 API call sites updated
- [ ] dataSourceId required in constructor
- [ ] ConfigManager validates dataSourceId
- [ ] Interactive setup fetches dataSourceId
- [ ] API version defaults to 2025-09-03

### Testing
- [ ] All unit tests pass
- [ ] Integration tests pass
- [ ] Real Notion page created with new API
- [ ] Migration from v2.0.0 tested

### Documentation
- [ ] MIGRATION_v3.md complete
- [ ] v3.0.0 release notes complete
- [ ] README updated
- [ ] CHANGELOG updated

### Quality
- [ ] No regressions
- [ ] Error messages helpful
- [ ] Migration path clear
- [ ] Rollback plan documented

---

## Timeline

- **Day 1:** Code changes (notion-client.js, ConfigManager.js)
- **Day 2:** Setup changes, testing
- **Day 3:** Documentation, migration guide
- **Day 4:** Final testing, QA
- **Day 5:** Release preparation

---

## Open Questions

1. ‚ùì **Notion SDK API:** Does `dataSources.query()` actually exist in SDK v5.1.0?
2. ‚ùì **Backward Compat:** Keep `databaseId` for any reason?
3. ‚ùì **Error Handling:** What if Notion doesn't enforce 2025-09-03 yet?
4. ‚ùì **Greasemonkey:** Update version or keep at v1.16.2?

**Resolution needed before proceeding.**

---

## Implementation Order

1. ‚úÖ Create branch `feature/v3.0.0-notion-api-2025-09-03`
2. ‚úÖ Create this implementation plan
3. ‚è≥ Research Notion SDK v5.1.0 API (verify dataSources.query exists)
4. ‚è≥ Update notion-client.js (4 changes)
5. ‚è≥ Update ConfigManager.js (validation)
6. ‚è≥ Update interactive-setup.js (fetch dataSourceId)
7. ‚è≥ Update config.example.json
8. ‚è≥ Update version numbers
9. ‚è≥ Create migration documentation
10. ‚è≥ Write tests
11. ‚è≥ Test implementation
12. ‚è≥ Create release notes

---

**Status:** üìù PLANNING COMPLETE
**Next Step:** Research Notion SDK v5.1.0 API
**Blocker:** Need to verify `dataSources.query()` exists in SDK

üéØ **Ready to implement once API verified**
